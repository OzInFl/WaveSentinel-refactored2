name: build-and-publish

permissions:
  contents: write  # required to push to gh-pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [published]

env:
  # Your PlatformIO environment name (from [env:...]) — adjust if needed.
  WORKFLOW_ENV: "WaveSentinel"
  DIST_DIR: dist
  PAGES_BRANCH: gh-pages

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio/.cache
            ~/.platformio/packages
            ~/.platformio/platforms
            ~/.platformio/penv
          key: pio-${{ runner.os }}-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO (and helpers)
        run: |
          python -m pip install -U platformio

      - name: Build (PlatformIO)
        run: |
          # Build the specified env
          pio run -e "$WORKFLOW_ENV"
          echo "Built files in .pio/build/$WORKFLOW_ENV:"
          ls -al .pio/build/"$WORKFLOW_ENV" || true

      - name: Collect firmware parts (no merge)
        shell: bash
        run: |
          set -e
          ENV_NAME="$WORKFLOW_ENV"
          OUT="$DIST_DIR"
          mkdir -p "$OUT"

          # Determine firmware filename (Arduino vs ESP-IDF)
          FW=""
          if [ -f ".pio/build/$ENV_NAME/firmware.bin" ]; then FW=".pio/build/$ENV_NAME/firmware.bin"; fi
          if [ -z "$FW" ] && [ -f ".pio/build/$ENV_NAME/project.bin" ]; then FW=".pio/build/$ENV_NAME/project.bin"; fi
          if [ -z "$FW" ]; then echo "No firmware bin found in .pio/build/$ENV_NAME"; exit 1; fi

          # Copy required parts (fail if missing — mirrors PIO flash layout for ESP32-S3 Arduino)
          cp -v ".pio/build/$ENV_NAME/bootloader.bin" "$OUT/bootloader.bin"
          cp -v ".pio/build/$ENV_NAME/partitions.bin"  "$OUT/partitions.bin"
          cp -v "$FW" "$OUT/app.bin"

          # boot_app0.bin is sometimes not emitted; fetch a known-good if absent
          if [ -f ".pio/build/$ENV_NAME/boot_app0.bin" ]; then
            cp -v ".pio/build/$ENV_NAME/boot_app0.bin" "$OUT/boot_app0.bin"
          else
            curl -L -o "$OUT/boot_app0.bin" https://raw.githubusercontent.com/espressif/arduino-esp32/2.0.17/tools/partitions/boot_app0.bin
          fi

          echo "Dist contents:"
          ls -al "$OUT"

      - name: Compute version string
        id: ver
        run: |
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            GIT_SHORT=$(git rev-parse --short HEAD)
            echo "version=0.0.$(date +%Y%m%d)-$GIT_SHORT" >> $GITHUB_OUTPUT
          fi

      - name: Write manifest.json (multi-part @ real offsets)
        shell: bash
        run: |
          set -e
          OUT="$DIST_DIR"
          # Conditionally include boot_app0 line with correct comma handling
          BOOT_APP0_LINE='{ "path": "boot_app0.bin", "offset": 57344 },'
          if [ ! -f "$OUT/boot_app0.bin" ]; then
            BOOT_APP0_LINE=""
          fi

          cat > "$OUT/manifest.json" << JSON
          {
            "name": "WaveSentinel (WT32-SC01-PLUS)",
            "version": "${{ steps.ver.outputs.version }}",
            "new_install_prompt_erase": true,
            "builds": [
              {
                "chipFamily": "ESP32-S3",
                "improv": false,
                "parts": [
                  { "path": "bootloader.bin", "offset": 0 },
                  { "path": "partitions.bin",  "offset": 32768 },
                  ${BOOT_APP0_LINE}
                  { "path": "app.bin",         "offset": 65536 }
                ]
              }
            ]
          }
          JSON

          echo "----- manifest.json -----"
          cat "$OUT/manifest.json"

      - name: Create index.html (web flasher)
        run: |
          cat > $DIST_DIR/index.html << 'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <title>WaveSentinel — WT32-SC01-PLUS Flasher</title>
          <h1>WaveSentinel — WT32-SC01-PLUS</h1>
          <p>Connect your WT32-SC01-PLUS (ESP32-S3) via USB, then click Install:</p>
          <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
          <esp-web-install-button manifest="./manifest.json">
            <button slot="activate" style="font-size:1.1rem;padding:.6rem 1rem;">Install WaveSentinel</button>
            <span slot="unsupported">Use Chrome/Edge on desktop over HTTPS.</span>
          </esp-web-install-button>
          <p style="margin-top:1rem;">After flashing, open the serial console or app UI to configure Wi-Fi.</p>
          HTML

      - name: Publish to GitHub Pages (gh-pages)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.DIST_DIR }}
          publish_branch: ${{ env.PAGES_BRANCH }}
          force_orphan: true
